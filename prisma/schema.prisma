generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  CUSTOMER
  TUNER
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  password         String?
  name             String?
  emailVerified    Boolean   @default(false)
  avatarUrl        String?
  authProvider     String?
  googleId         String?   @unique
  twitterId        String?   @unique
  userType         UserType  @default(CUSTOMER)
  tokenVersion     Int       @default(0)
  failedLogins     Int       @default(0)
  lockedUntil      DateTime?
  lastLoginAt      DateTime?
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecret  String?
  isSuspended      Boolean   @default(false)
  phone            String?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  sessions         Session[]

  @@map("users")
  @@index([email])
}

model Session {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  device     String?
  location   String?
  createdAt  DateTime @default(now()) @map("created_at")
  lastActive DateTime @updatedAt @map("last_active")
  isActive   Boolean  @default(true) @map("is_active")
  user       User     @relation(fields: [userId], references: [id])

  @@map("sessions")
  @@index([userId])
}

model PasswordlessToken {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  type      String
  code      String?
  expiresAt DateTime  @map("expires_at")
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at")
  ipAddress String?   @map("ip_address")
  userAgent String?   @map("user_agent")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("passwordless_tokens")
  @@index([email])
  @@index([token])
  @@index([code])
  @@index([expiresAt])
}

model Repository {
  id            String     @id @default(uuid())
  githubUrl     String     @map("github_url")
  name          String
  ownerId       String     @map("owner_id")
  lastAnalyzedAt DateTime? @map("last_analyzed_at")
  createdAt     DateTime   @default(now()) @map("created_at")
  analyses      Analysis[]

  @@map("repositories")
}

model Analysis {
  id             String     @id @default(uuid())
  repositoryId   String     @map("repository_id")
  repository     Repository @relation(fields: [repositoryId], references: [id])
  score          Int
  totalIssues    Int        @map("total_issues")
  criticalIssues Int        @map("critical_issues")
  highIssues     Int        @map("high_issues")
  mediumIssues   Int        @map("medium_issues")
  analyzedAt     DateTime   @default(now()) @map("analyzed_at")
  issues         Issue[]

  @@map("analyses")
}

model Issue {
  id              String     @id @default(uuid())
  analysisId      String     @map("analysis_id")
  analysis        Analysis   @relation(fields: [analysisId], references: [id])
  type            String
  severity        String
  filePath        String     @map("file_path")
  lineNumber      Int?       @map("line_number")
  title           String
  description     String?
  codeBefore      String?    @map("code_before")
  codeAfter       String?    @map("code_after")
  estimatedImpact Json?      @map("estimated_impact")
  createdAt       DateTime   @default(now()) @map("created_at")
  solutions       Solution[]

  @@map("issues")
}

model Solution {
  id              String   @id @default(uuid())
  issueId         String   @map("issue_id")
  issue           Issue    @relation(fields: [issueId], references: [id])
  type            String
  description     String
  codeAfter       String   @map("code_after")
  explanation     String?
  estimatedImpact String?  @map("estimated_impact")
  difficulty      String?
  fitnessScore    Float    @map("fitness_score")
  rank            Int
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("solutions")
}
